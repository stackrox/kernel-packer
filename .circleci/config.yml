version: 2

jobs:
  lint:
    docker:
    - image: circleci/golang:1.11.5
    working_directory: /go/src/github.com/stackrox/kernel-packer
    steps:
    - checkout
    - run:
        name: Install dependencies
        command: |
          go get golang.org/x/tools/cmd/goimports
    - run:
        name: Run tests
        command: |
          gofiles="$(find . -name '*.go' | grep -v /vendor/)"
          test -z "$(goimports -l -local github.com/stackrox/kernel-packer $gofiles)"

  manifest:
    docker:
    - image: circleci/golang:1.11.5
    working_directory: /go/src/github.com/stackrox/kernel-packer
    steps:
    - checkout
    - run:
        name: Generate manifest
        command: make manifest | tee manifest.yml
    - persist_to_workspace:
        root: .
        paths:
        - manifest.yml

  repackage:
    docker:
      - image: circleci/golang:1.11.5
    working_directory: /go/src/github.com/stackrox/kernel-packer
    steps:
      - checkout
      - attach_workspace:
          at: /go/src/github.com/stackrox/kernel-packer
      - run:
          name: Print manifest
          command: cat manifest.yml

  crawl:
    docker:
    - image: circleci/golang:1.11.5
    steps:
    - checkout
    - setup_remote_docker
    - run:
        name: Crawl package repositories
        command: make crawl
    - run:
        name: Push any changes
        command: make robo-commit

workflows:
  version: 2

  build:
    jobs:
    - lint
    - manifest
    - repackage:
        requires:
        - manifest

  cron:
    jobs:
    - crawl
    triggers:
    - schedule:
        cron: "0 0,3,6,9,12,15,18,21 * * *"
        filters:
          branches:
            only:
            - master
