version: 2.1

commands:
  gcloud-init:
    steps:
    - run:
        name: Install and configure gcloud
        working_directory: ~/.config/gcloud
        command: |
          pip install -U crcmod google_compute_engine
          gcloud auth activate-service-account --key-file <(echo "$GOOGLE_CREDENTIALS_KERNEL_CACHE")
          gcloud auth list

jobs:
  lint:
    docker:
    - image: circleci/golang:1.11.5
    working_directory: /go/src/github.com/stackrox/kernel-packer
    steps:
    - checkout
    - run:
        name: Install dependencies
        command: |
          go get golang.org/x/tools/cmd/goimports
    - run:
        name: Run linters
        command: |
          gofiles="$(find . -name '*.go' | grep -v /vendor/)"
          test -z "$(goimports -l -local github.com/stackrox/kernel-packer $gofiles)"
    - run:
        name: Run tests
        command: go test -v ./...

  repackage:
    machine: true
    parallelism: 3
    environment:
    - GOPATH: /home/circleci/go
    working_directory: /home/circleci/go/src/github.com/stackrox/kernel-packer
    steps:
    - gcloud-init
    - checkout
    - attach_workspace:
        at: .
    - run:
        name: Sanity check manifest
        command: cat kernel-package-lists/manifest.yml
    - run:
        name: Download cache
        command: |
          mkdir -p .build-data/cache
          touch .build-data/cache/cache.yml
    - run:
        name: Generate package list
        command: make list-files
    - run:
        name: Download package list
        command: make download-files
    - run:
        name: Repackage kernels
        command: make repackage
    - persist_to_workspace:
        root: .
        paths:
        - .build-data/cache

  combine:
    docker:
    - image: circleci/golang:1.11.5
    environment:
    - GOPATH: /home/circleci/go
    working_directory: /home/circleci/go/src/github.com/stackrox/kernel-packer
    steps:
    - checkout
    - attach_workspace:
        at: .
    - run:
        name: Sanity check fragments
        command: ls -lh .build-data/cache
    - run:
        name: Combine cache fragments
        command: |
          make combine-cache
          make clean-cache
    - run:
        name: Upload cache
        command: cat .build-data/cache/cache.yml

  crawl:
    machine: true
    environment:
    - GOPATH: /home/circleci/go
    working_directory: /home/circleci/go/src/github.com/stackrox/kernel-packer
    steps:
    - gcloud-init
    - checkout
    - run:
        name: Crawl package repositories
        command: make crawl
    - run:
        name: Download and reupload crawled files
        command: make sync
    - run:
        name: Generate manifest
        command: |
          make manifest
          cat kernel-package-lists/manifest.yml
    - run:
        name: Push any changes
        command: make robo-commit

workflows:
  version: 2

  build:
    jobs:
    - lint
    - repackage
    - combine:
        requires:
        - repackage
    - crawl:
        filters:
          branches:
            only:
            - /.*dev-crawl.*/

  cron:
    jobs:
    - crawl
    triggers:
    - schedule:
        cron: "0 0,3,6,9,12,15,18,21 * * *"
        filters:
          branches:
            only:
            - master
