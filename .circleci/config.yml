version: 2.1

orbs:
  slack: circleci/slack@3.4.2

commands:
  gcloud-init:
    steps:
    - run:
        name: Install and configure gcloud
        working_directory: ~/.config/gcloud
        command: |
          if [[ "$NO_INSTALL_GCLOUD" != "true" ]]; then
            pip install --upgrade pip
            pip install wheel
            pip install -U crcmod google_compute_engine
            pip install -U gcloud gsutil
            echo "Updating path to pick up proper gsutil binary"
            export PATH="/opt/google-cloud-sdk/bin:$PATH"
            echo 'export PATH="/opt/google-cloud-sdk/bin:$PATH"' >>"$BASH_ENV"
            sudo chown circleci:circleci /opt
          fi
          echo "Updating gcloud/gsutil ..."
          gcloud config set core/disable_prompts True
          gcloud components install gsutil -q
          gcloud components update -q
          gcloud auth activate-service-account --key-file <(echo "$GOOGLE_CREDENTIALS_KERNEL_CACHE")
          gcloud auth list

          # Sanity check
          echo "Using gsutil from $(which gsutil)"
          echo "Checking that gsutil binary is functional"
          gsutil ls 'gs://stackrox-kernel-packages/' >/dev/null

jobs:
  lint:
    docker:
    - image: circleci/golang:1.11.5
    working_directory: /go/src/github.com/stackrox/kernel-packer
    steps:
    - checkout
    - run:
        name: Install dependencies
        command: |
          go get golang.org/x/tools/cmd/goimports
    - run:
        name: Run linters
        command: |
          gofiles="$(find . -name '*.go' | grep -v /vendor/)"
          test -z "$(goimports -l -local github.com/stackrox/kernel-packer $gofiles)"
    - run:
        name: Run tests
        command: go test -v ./...

  repackage:
    machine: true
    parallelism: 5
    environment:
    - GOPATH: /home/circleci/go
    working_directory: /home/circleci/go/src/github.com/stackrox/kernel-packer
    steps:
    - gcloud-init
    - checkout
    - restore_cache:
        key: stackrox-kernel-packer-cache-v12
    - run:
        name: Sanity check cache
        command: |
          mkdir -p .build-data/cache
          touch .build-data/cache/cache.yml
          cat .build-data/cache/cache.yml
    - run:
        name: Sanity check manifest
        command: cat kernel-package-lists/manifest.yml
    - run:
        name: Generate package list
        command: make list-files
    - run:
        name: Download package list
        command: make download-packages-from-gcs
    - run:
        name: Build repackage image
        command: make packers
    - run:
        name: Repackage kernels
        command: make repackage
    - run:
        name: Sanity check bundles
        command: |
          mkdir -p .build-data/bundles
          ls -lhR .build-data/bundles
    - run:
        name: Upload bundles
        command: make upload-bundles
    - persist_to_workspace:
        root: .
        paths:
        - .build-data/cache

    - slack/status:
        fail_only: true
        mentions: S0154UALQMB
        only_for_branches: master
        webhook: '${SLACK_WEBHOOK_ONCALL}'

  combine:
    docker:
    - image: circleci/golang:1.11.5
    environment:
    - GOPATH: /home/circleci/go
    working_directory: /home/circleci/go/src/github.com/stackrox/kernel-packer
    steps:
    - checkout
    - attach_workspace:
        at: .
    - run:
        name: Sanity check fragments
        command: ls -lh .build-data/cache

    - run:
        name: Combine cache fragments
        command: |
          make combine-cache
          make clean-cache

    - run:
        name: Sanity check cache
        command: cat .build-data/cache/cache.yml

    - run:
        name: Stop when not on master
        command: |
          [[ "$CIRCLE_BRANCH" == "master" ]] || circleci step halt

    - save_cache:
        key: stackrox-kernel-packer-cache-v12-{{ epoch }}
        paths:
        - .build-data/cache/cache.yml

  crawl:
    machine: true
    environment:
    - GOPATH: /home/circleci/go
    working_directory: /home/circleci/go/src/github.com/stackrox/kernel-packer
    steps:
    - gcloud-init
    - checkout

    - run:
        name: Crawl package repositories
        command: make crawl

    - run:
        name: Download package files
        command: make download-packages

    - run:
        name: Upload package files (only on master)
        command: |
          [[ "$CIRCLE_BRANCH" == "master" ]] || exit 0
          make upload-packages

    - restore_cache:
        key: stackrox-kernel-packer-cache-v12

    - run:
        name: Generate manifest
        command: |
          make manifest
          cat kernel-package-lists/manifest.yml

    - run:
        name: Prepare artifacts
        command: |
          rm -rf .build-data/downloads
        when: always

    - store_artifacts:
        path: .build-data
        destination: build-data
        when: always

    - run:
        name: Build repackage image (non-master)
        command: |
          [[ "$CIRCLE_BRANCH" != "master" ]] || exit 0
          make packers

    - run:
        name: Repackage kernels (non-master)
        command: |
          [[ "$CIRCLE_BRANCH" != "master" ]] || exit 0
          make repackage

    - run:
        name: Sanity check bundles (non-master)
        command: |
          [[ "$CIRCLE_BRANCH" != "master" ]] || exit 0
          mkdir -p .build-data/bundles
          ls -lhR .build-data/bundles

    - run:
        name: Upload bundles (non-master)
        command: |
          [[ "$CIRCLE_BRANCH" != "master" ]] || exit 0
          make upload-bundles KERNEL_BUNDLE_BUCKET="gs://stackrox-kernel-bundles-staging/${CIRCLE_BUILD_NUM}"

    - run:
        name: Stop execution when not on master
        command: |
          [[ "$CIRCLE_BRANCH" == "master" ]] || circleci step halt

    - add_ssh_keys:
        fingerprints:
        - 'dd:79:df:69:0f:13:db:0e:08:3e:3b:f4:b2:e3:57:77'

    - run:
        name: Push any changes
        command: |
          [[ "$CIRCLE_BRANCH" == "master" ]] || exit 0
          make robo-crawl-commit

    - slack/status:
        fail_only: true
        mentions: S0154UALQMB
        only_for_branches: master
        webhook: '${SLACK_WEBHOOK_ONCALL}'

  collector:
    docker:
      - image: google/cloud-sdk:295.0.0-alpine
    environment:
      NO_INSTALL_GCLOUD: true
    steps:
      - run:
          name: Install dependencies
          command: apk add --no-cache py-pip make
      - gcloud-init
      - checkout
      - add_ssh_keys:
          fingerprints:
          - "7f:08:58:1e:80:80:6e:66:99:9a:37:cb:e9:96:0b:40"
      - run:
          name: Update collector kernel versions
          command: make robo-collector-commit

workflows:
  version: 2

  build:
    jobs:
    - lint
    - repackage
    - combine:
        requires:
        - repackage
    - collector:
        requires:
        - combine
        filters:
          branches:
            only:
              - master
    - crawl:
        context: redhat-login
        filters:
          branches:
            only:
            - /.*dev-crawl.*/
            - master

  cron:
    jobs:
    - crawl:
        context: redhat-login
    triggers:
    - schedule:
        cron: "0 * * * *"
        filters:
          branches:
            only:
            - master
