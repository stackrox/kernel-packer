#!/usr/bin/env bash

DIR="$(cd "$(dirname "$0")" && pwd)"

info() {
    echo "[INFO] $*" 1>&2
}

main() {
    # Directory that holds the crawled url text files.
    #
    # Example: "./kernel-package-lists"
    package_list_dir="$1"

    # GCS bucket containing uploaded files.
    #
    # Example: "gs://stackrox-kernel-packages"
    bucket_name_list="$2"
    IFS=',' read -r -a bucket_names <<< "$bucket_name_list"

    # Directory to download urls into.
    #
    # Example: ".build-data/downloads"
    download_dir="$3"
    mkdir -p "$download_dir"

    info 'Generating a list of crawled urls.'
    all_crawled_packages="$(./scripts/crawled-inventory "$package_list_dir")"
    echo "$all_crawled_packages"
    echo

    info 'Generating a list of bucket files.'
    all_bucket_files="$(./scripts/package-inventory "$bucket_name_list")"
    echo "$all_bucket_files"
    echo

    info 'Downloading missing files from origin source.'
    while read -r url; do
        # Simplify url into the naming scheme used in the bucket.
        filename="$(simplify "$url")"

        # Check if this specific file exists in the bucket listing.
        if ! echo "$all_bucket_files" | contains "$filename"; then
            echo "Downloading $url"

            # This file didn't exist in the bucket listing, so download it.
            download "$url" "${download_dir}/${filename}"
        fi
    done <<< "$all_crawled_packages"
    echo

    info 'Sanity checking downloaded files.'
    find "${download_dir}" -size 0 -delete -print
    echo

    info "Uploading files to ${bucket_names[0]}/"
    find "$download_dir" -type f | gsutil -m cp -I "${bucket_names[0]%/}/"
    echo
}

contains() {
    grep -qF "$1"
}

download() {
    url="$1"
    file="$2"
    if echo "$url" | contains 'cdn.redhat.com'; then
        wget \
            --no-check-certificate \
            --certificate .build-data/rhel-certs/rhel-cert.pem \
            --private-key .build-data/rhel-certs/rhel-key.pem \
            -nv "$url" -O "$file" || rm -f "$file"
    elif echo "$url" | contains 'docker.io'; then
        wget \
            --header "$("${DIR}/docker-desktop/auth-header.sh" "$url")" \
            -nv "$url" -O "$file" || rm -f "$file"
    elif echo "$url" | contains 'updates.suse.com'; then
        base_url="$(echo "$url" | rev | cut -d'/' -f3- | rev)/"
        tokens_file="${DIR}/../.build-data/suse-repo-tokens/repos.json"
        token="$(jq -r --arg BASE_URL "${base_url}" '.[]|select(.url|contains($BASE_URL))|.token' "${tokens_file}")"
        wget -nv "${url}?${token}" -O "$file" || rm -f "$file"
    elif echo "$url" | contains 'esm.ubuntu.com'; then
        wget -nv --user "bearer" --password "$UBUNTU_ESM_INFRA_BEARER_TOKEN" "$url" -O "$file" || rm -f "$file"
    else
        wget -nv "$url" -O "$file" || rm -f "$file"
    fi
}

simplify() {
    echo "$1" | tr -c 'a-zA-Z0-9_.\n' '-'
}

main "$@"
