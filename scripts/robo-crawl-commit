#!/usr/bin/env bash
set -eu

main() {
    CRAWLED_PACKAGE_DIR="${1:-kernel-package-lists}"

    refresh_repo .

    # Check if there are actually any changes. If no files have been modified,
    # don't bother committing.
    if git diff-index --quiet HEAD -- "$CRAWLED_PACKAGE_DIR"; then
        echo "Crawled packages are up to date. Stopping build."
        return 0
    fi

    echo "New crawled packages found!"

    # temporary test branch
    git checkout crawl-test

    # Create a commit with any modified files, and push it to GitHub.
    git add "$CRAWLED_PACKAGE_DIR"
    git -c "user.name=roxbot" -c "user.email=roxbot@stackrox.com" commit --message "ğŸ¤– Updated crawled packages"

    # redirect to devnull so this doesn't print the value of the token on failure.
    git remote add pushtarget https://roxbot:$GITHUB_TOKEN@github.com/stackrox/kernel-packer &> /dev/null

    # redirect to devnull so this doesn't print the value of the token on failure.
    # temporary test branch
    git push pushtarget crawl-test &> /dev/null
    echo "Crawled packages have been pushed."
}

refresh_repo() {
    repo_dir="$1"

    git -C "$repo_dir" update-index -q --refresh 1>/dev/null 2>&1 || true
}

main "$@"
