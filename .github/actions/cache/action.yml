name: Cache
description: Runs the kernel-packer cache step

runs:
  using: composite
  steps:
    - name: Combine cache
      run: make combine-cache
      shell: bash

    - name: Clean cache
      run: make clean-cache
      shell: bash

    - name: Sanity check bundles
      run: |
        IFS=',' read -r -a bucket_names <<< "${KERNEL_BUNDLE_BUCKET}"
        for bucket_name in "${bucket_names[@]}"; do
          echo "Kernel versions in ${bucket_name}"
          gsutil ls "${bucket_name}/**.tgz" | \
            sed 's|^.*bundle-||' | sed 's|\.tgz$||' | sort || true
        done

        gsutil cp .build-data/cache/cache.yml "${bucket_names[0]}/cache.yml"
      shell: bash
