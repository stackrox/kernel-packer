name: Repackage Bundles

on: workflow_call

jobs:
  comment-on-pr:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - uses: google-github-actions/auth@v1
        with:
          credentials_json: '${{ secrets.GOOGLE_CREDENTIALS_KERNEL_CACHE }}'
      - uses: google-github-actions/setup-gcloud@v1

      - uses : ./.github/actions/env

      - shell: bash
        id: formatted-comment
        run: |
          # shellcheck disable=SC2153
          IFS=',' read -ra KERNEL_PACKAGE_BUCKETS <<< "${KERNEL_PACKAGE_BUCKET}"
          # shellcheck disable=SC2153
          IFS=',' read -ra KERNEL_BUNDLE_BUCKETS <<< "${KERNEL_BUNDLE_BUCKET}"

          export PACKAGE_COUNT
          export BUNDLE_COUNT
          export LAST_UPDATED

          PACKAGE_COUNT="$(gsutil ls "${KERNEL_PACKAGE_BUCKETS[0]}" | wc -l | xargs)"
          BUNDLE_COUNT="$(gsutil ls "${KERNEL_BUNDLE_BUCKETS[0]}" | wc -l | xargs)"
          LAST_UPDATED="$(date)"

          formatted_comment="$(mktemp)"

          envsubst < ${{ github.action_path }}/comment.md > "${formatted_comment}"
          echo "comment-file=${formatted_comment}" >> "${GITHUB_OUTPUT}"

      - name: Comment on PR
        uses: mshick/add-pr-comment@v2
        with:
          message-path: ${{ steps.formatted-comment.outputs.comment-file }}
          message-id: crawl-results

